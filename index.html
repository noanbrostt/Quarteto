<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Torneio Quartetos — Controle (Firestore)</title>
    <link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet">
    <style>
        :root {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --border: #e5e7eb;
            --bg-card: #ffffff;
            --bg-tab: #f8fafc;
            --tab-active: #ffffff;
        }

        body {
            max-width: 100%;
            margin: 0 auto;
            padding: 12px;
            background-color: #f8fafc;
            font-size: 14px;
        }

        h1 {
            margin: 0 0 15px;
            color: #1e293b;
            text-align: center;
            font-size: 1.5rem;
        }

        h2 {
            color: #334155;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        h3 {
            color: #475569;
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        /* Navegação Mobile */
        .nav-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--primary);
            background: white;
            font-size: 1rem;
            font-weight: 500;
            color: #1e293b;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%232563eb'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
        }

        .tab-content {
            display: none;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 12px;
            background: var(--bg-card);
            margin-bottom: 15px;
        }

        button {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #888;
            background: #f3f3f3;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        button:hover {
            background: #e5e5e5;
        }

        button.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        button.primary:hover {
            background: var(--primary-dark);
        }

        button.danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        button.small {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        input,
        select,
        textarea {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.9rem;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px 8px;
            text-align: left;
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
        }

        .qrcode {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .qrcode img {
            max-width: 200px;
            height: auto;
        }

        .match-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: #f8fafc;
            flex-wrap: wrap;
        }

        /* NOVO LAYOUT PARA PARTIDAS - MOBILE FIRST */
        .match-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            animation: fadeInUp 0.3s ease;
        }

        .match-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f1f5f9;
        }

        .match-code {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
            background: #e0e7ff;
            padding: 2px 8px;
            border-radius: 6px;
        }

        .match-status {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .match-status.finished {
            background: #dcfce7;
            color: #166534;
        }

        .match-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .match-content {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .team {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .team-name {
            font-weight: 500;
            text-align: center;
            font-size: 0.9rem;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            min-height: 2.4em;
        }

        .team-score {
            font-weight: bold;
            font-size: 1.1rem;
            padding: 2px 8px;
            border-radius: 6px;
            background: #f8fafc;
            min-width: 30px;
            text-align: center;
        }

        .team-score.winner {
            background: var(--primary);
            color: white;
        }

        .vs-divider {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 4px;
            min-width: 40px;
        }

        .vs-text {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .match-pending-text {
            text-align: center;
            color: #64748b;
            font-style: italic;
            font-size: 0.85rem;
            padding: 4px;
            background: #f8fafc;
            border-radius: 4px;
        }

        .match-result {
            text-align: center;
            color: #059669;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 4px;
        }

        /* Estados visuais diferentes */
        .match-finished {
            border-left: 3px solid var(--success);
        }

        .match-pending {
            border-left: 3px solid #f59e0b;
        }

        .small {
            font-size: 0.85rem;
            color: #64748b;
        }

        .danger {
            color: var(--danger);
        }

        .ok {
            color: var(--success);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            background: #e0e7ff;
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 6px
        }

        .muted {
            color: #64748b;
            font-size: 0.85rem
        }

        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        .login-form {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .match-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .score-input {
            width: 60px;
            text-align: center;
            font-size: 1rem;
        }

        .team-list {
            list-style: none;
            padding: 0;
        }

        .team-card {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .team-card h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .players-list {
            color: #64748b;
            font-size: 0.95rem;
        }

        .round-section {
            margin-bottom: 25px;
        }

        .round-title {
            background: #e0e7ff;
            color: var(--primary);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 1rem;
        }

        .admin-only {
            display: none;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--primary);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .status-bar {
            background: #f1f5f9;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        /* MELHORIA: Cards para classificação em mobile */
        .ranking-cards {
            display: none;
        }

        .ranking-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ranking-position {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .ranking-team {
            font-weight: 600;
            flex: 1;
            margin: 0 10px;
        }

        .ranking-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.85rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
        }

        /* MELHORIA: Layout melhor para gerenciar partidas em mobile */
        .admin-match-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .admin-match-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .admin-match-teams {
            flex: 1;
            min-width: 200px;
        }

        .admin-match-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .loading-text {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }

        /* Animações */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Media Queries para responsividade */
        @media (max-width: 768px) {
            .ranking-table {
                display: none;
            }

            .ranking-cards {
                display: block;
            }

            .admin-match-header {
                flex-direction: column;
            }

            .admin-match-controls {
                width: 100%;
                justify-content: space-between;
            }

            .score-input {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .admin-actions {
                grid-template-columns: 1fr;
            }

            .flex {
                flex-direction: column;
                align-items: stretch;
            }

            .status-bar {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .match-controls {
                justify-content: center;
            }

            .admin-match-controls {
                flex-direction: column;
                width: 100%;
            }

            .admin-match-controls .score-input {
                width: 100%;
            }

            /* Layout vertical para partidas em mobile */
            .match-content {
                flex-direction: column;
                gap: 6px;
            }

            .team {
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
                padding: 4px 0;
            }

            .team-name {
                text-align: left;
                -webkit-line-clamp: 1;
                min-height: auto;
            }

            .vs-divider {
                margin: 2px 0;
            }

            .vs-text {
                transform: rotate(0deg);
                padding: 2px 12px;
            }

            .team-score {
                font-size: 1rem;
                min-width: 25px;
            }
        }

        @media (max-width: 360px) {
            body {
                padding: 8px;
            }

            .card {
                padding: 10px;
            }

            h1 {
                font-size: 1.3rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            .match-header {
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
            }

            .match-status {
                align-self: flex-end;
            }

            .team-name {
                font-size: 0.85rem;
            }

            .team-score {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <h1>🏐 Torneio Quartetos</h1>

    <!-- Navegação Mobile -->
    <div class="nav-container">
        <select class="nav-select" id="navSelect">
            <option value="public">📱 Público</option>
            <option value="teams">👥 Times</option>
            <option value="matches">🎯 Partidas</option>
            <option value="ranking">🏆 Classificação</option>
            <option value="admin">🔐 Administração</option>
            <option value="create-teams" class="admin-only">➕ Gerenciar Times</option>
            <option value="manage-matches" class="admin-only">⚽ Gerenciar Partidas</option>
        </select>
    </div>

    <!-- Aba Pública -->
    <div id="public-tab" class="tab-content">
        <div class="card">
            <h2>🎉 Bem-vindo ao Torneio de Vôlei Quarteto!</h2>
            <p>Este é o sistema de controle e acompanhamento do torneio. Acompanhe aqui os resultados em tempo real!</p>

            <div class="qrcode">
                <h3>📱 Acesso Rápido</h3>
                <p class="small">Escaneie este QR Code para acessar o site em outro dispositivo:</p>
                <div id="qrcode"></div>
            </div>
        </div>

        <div class="card">
            <h3>📋 Regras do Campeonato</h3>
            <div class="col">
                <div class="flex">
                    <strong>🏐 Formato:</strong>
                    <span>Quartetos (4-5 jogadores por time)</span>
                </div>
                <div class="flex">
                    <strong>⚔️ Confrontos:</strong>
                    <span>1 set de 15 pontos cada</span>
                </div>
                <div class="flex">
                    <strong>🏆 Critérios de Desempate:</strong>
                </div>
                <div class="small" style="margin-left: 15px;">
                    <div>1. <strong>Maior número de vitórias</strong></div>
                    <div>2. <strong>Confronto direto</strong> entre os times empatados</div>
                    <div>3. <strong>Melhor saldo de pontos</strong> (pontos feitos - pontos sofridos)</div>
                </div>
                <div class="flex">
                    <strong>📊 Partidas:</strong>
                    <span>12 partidas no total (P9 e P10 são opcionais)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba Times -->
    <div id="teams-tab" class="tab-content">
        <div class="card">
            <h2>👥 Times Participantes</h2>
            <p class="small">Lista de todos os times e seus jogadores</p>
            <div id="publicTeams"></div>
        </div>
    </div>

    <!-- Aba Partidas -->
    <div id="matches-tab" class="tab-content">
        <div class="card">
            <h2>🎯 Partidas do Torneio</h2>
            <p class="small">Acompanhe todos os jogos e resultados</p>
            <div id="publicMatches"></div>
        </div>
    </div>

    <!-- Aba Classificação -->
    <div id="ranking-tab" class="tab-content">
        <div class="card">
            <h2>🏆 Classificação</h2>

            <!-- Tabela para desktop -->
            <div class="ranking-table">
                <table>
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Time</th>
                            <th>Vitórias</th>
                            <th>Derrotas</th>
                            <th>Pontos Pró</th>
                            <th>Pontos Contra</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="publicRanking"></tbody>
                </table>
            </div>

            <!-- Cards para mobile -->
            <div class="ranking-cards" id="publicRankingCards"></div>
        </div>
    </div>

    <!-- Aba Administração -->
    <div id="admin-tab" class="tab-content">
        <div class="card">
            <h2>🔐 Área Administrativa</h2>

            <div id="login-section">
                <div class="login-form">
                    <h3>Login</h3>
                    <div class="col">
                        <div class="form-group">
                            <label for="loginUser">Usuário</label>
                            <input id="loginUser" placeholder="admin" value="admin">
                        </div>
                        <div class="form-group">
                            <label for="loginPass">Senha</label>
                            <input id="loginPass" type="password" placeholder="senha123" value="senha123">
                        </div>
                        <div class="flex">
                            <button id="btnLogin" class="primary">Entrar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-section" style="display: none;">
                <div class="status-bar ok">
                    <div>
                        <strong>✅ Logado como Administrador</strong>
                    </div>
                    <button id="btnLogout" class="danger small">Sair</button>
                </div>

                <h3>⚙️ Configurações</h3>
                <div class="card">
                    <div class="toggle-container">
                        <label for="toggleOptional">Partidas opcionais P9/P10:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggleOptional">
                            <span class="toggle-slider"></span>
                        </label>
                        <span id="flagLabel" class="badge">SIM</span>
                    </div>
                    <small class="muted">Se ativado, as partidas P9 e P10 serão criadas.</small>
                </div>

                <h3>🛠️ Ferramentas</h3>
                <div class="admin-actions">
                    <button id="btnGenerate" class="primary">Montar Rodada 1</button>
                    <button id="btnPrepareR2">Montar Rodada 2</button>
                    <button id="btnPrepareR3">Montar Rodada 3</button>
                    <button id="btnRefresh">Atualizar Dados</button>
                    <button id="btnDeleteAll" class="danger">Apagar Tudo</button>
                </div>

                <div class="small muted">
                    <strong>Instruções:</strong>
                    <ol>
                        <li>Cadastre os times na aba "Criar Times"</li>
                        <li>Gere as partidas com os botões acima</li>
                        <li>Gerencie os placares na aba "Gerenciar Partidas"</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba Criar Times (Admin) -->
    <div id="teams-admin-section" style="display: none;">
        <div id="create-teams-tab" class="tab-content admin-only">
            <div class="card">
                <h2>👥 Gerenciar Times</h2>

                <div class="col">
                    <div class="form-group">
                        <label for="teamName">Nome do Time</label>
                        <input id="teamName" placeholder="Ex: Quarteto Azul">
                    </div>
                    <div class="form-group">
                        <label for="teamPlayers">Jogadores (separar por vírgula)</label>
                        <input id="teamPlayers" placeholder="Ex: Ana, Bia, Carla, Duda">
                    </div>
                    <div class="flex">
                        <button id="btnAddTeam" class="primary">Adicionar Time</button>
                        <button id="btnClearTeams" class="danger">Limpar Todos os Times</button>
                    </div>
                </div>

                <h3>📋 Times Registrados</h3>
                <div id="adminTeams"></div>
            </div>
        </div>
    </div>

    <!-- Aba Gerenciar Partidas (Admin) -->
    <div id="matches-admin-section" style="display: none;">
        <div id="manage-matches-tab" class="tab-content admin-only">
            <div class="card">
                <h2>⚽ Gerenciar Partidas</h2>

                <div class="admin-actions">
                    <button id="btnGenerate2" class="primary">Montar Rodada 1</button>
                    <button id="btnPrepareR2-2">Montar Rodada 2</button>
                    <button id="btnPrepareR3-2">Montar Rodada 3</button>
                </div>

                <h3>🎯 Controle de Partidas</h3>
                <div id="adminMatches"></div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIGURAÇÕES ---
        const ADMIN_USER = "admin";
        const ADMIN_PASS = "senha123";
        let INCLUI_PARTIDAS_OPCIONAIS = true;

        const firebaseConfig = {
            apiKey: "AIzaSyAR-_FoaRE956Kg3hlC43P6wRST1vRA56w",
            authDomain: "quarteto-237af.firebaseapp.com",
            projectId: "quarteto-237af",
            storageBucket: "quarteto-237af.firebasestorage.app",
            messagingSenderId: "239544086557",
            appId: "1:239544086557:web:97f14596ad0a72ebd4d6f4",
            measurementId: "G-HZ1YZKEC6J"
        };

        function showLoading() {
            $('#publicMatches').html('<div class="loading-text">🔄 Atualizando...</div>');
            $('#publicRanking').html('<div class="loading-text">🔄 Atualizando...</div>');
            $('#publicTeams').html('<div class="loading-text">🔄 Atualizando...</div>');
        }

        // Inicializar Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firestore inicializado com sucesso");
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            alert("Erro na configuração do Firebase. Verifique o console.");
        }

        // Utilitários
        function uid() {
            return 'id' + Math.random().toString(36).slice(2, 9);
        }

        // --- FUNÇÕES FIREBASE ---
        async function addTeamToDB(team) {
            if (!db) throw new Error("Firestore não inicializado");
            await db.collection('teams').doc(team.id).set(team);
        }

        async function getTeamsSnap() {
            if (!db) throw new Error("Firestore não inicializado");
            const snap = await db.collection('teams').get();
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        async function deleteAllTeams() {
            if (!db) throw new Error("Firestore não inicializado");
            const snap = await db.collection('teams').get();
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }

        async function addMatchToDB(match) {
            if (!db) throw new Error("Firestore não inicializado");
            await db.collection('matches').doc(match.id).set(match);
        }

        async function updateMatchInDB(id, patch) {
            if (!db) throw new Error("Firestore não inicializado");
            await db.collection('matches').doc(id).update(patch);
        }

        async function getMatchesSnap() {
            if (!db) throw new Error("Firestore não inicializado");
            const snap = await db.collection('matches').get();
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        async function deleteAllMatches() {
            if (!db) throw new Error("Firestore não inicializado");
            const snap = await db.collection('matches').get();
            const batch = db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
        }

        // --- LISTENERS EM TEMPO REAL ---
        function setupRealtime() {
            if (!db) return;

            // Mostrar loading quando começar a escutar mudanças
            showLoading();

            db.collection('teams').onSnapshot((snapshot) => {
                renderPublic();
                if (isAdmin()) {
                    renderAdminTeams();
                    renderAdminMatches();
                }
            });

            db.collection('matches').onSnapshot((snapshot) => {
                renderPublic();
                if (isAdmin()) {
                    renderAdminTeams();
                    renderAdminMatches();
                }
            });
        }

        function isAdmin() {
            return localStorage.getItem('isAdmin') === 'true';
        }

        // --- RENDERIZAÇÃO PÚBLICA ---
        async function renderPublic() {
            try {
                const teams = await getTeamsSnap();
                const matches = await getMatchesSnap();

                // Lista de times - JOGADORES EM ORDEM ALFABÉTICA
                $('#publicTeams').empty();
                teams.forEach(t => {
                    const playersSorted = [...(t.players || [])].sort((a, b) => a.localeCompare(b));

                    $('#publicTeams').append(
                        `<div class="team-card">
                            <h4>${t.name}</h4>
                            <div class="players-list">
                                ${playersSorted.join(', ')}
                            </div>
                        </div>`
                    );
                });

                // Classificação - COM DERROTAS
                const ranked = computeRankingFromData(teams, matches);

                // Tabela para desktop
                $('#publicRanking').empty();
                // Cards para mobile
                $('#publicRankingCards').empty();

                ranked.forEach((r, index) => {
                    const position = index + 1;
                    const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : position;
                    const totalMatches = (r.wins || 0) + (r.losses || 0);

                    // Tabela desktop
                    $('#publicRanking').append(
                        `<tr>
                            <td><strong>${medal}</strong></td>
                            <td><strong>${r.name}</strong></td>
                            <td>${r.wins || 0}</td>
                            <td>${r.losses || 0}</td>
                            <td>${r.scored || 0}</td>
                            <td>${r.conceded || 0}</td>
                            <td>${(r.scored || 0) - (r.conceded || 0)}</td>
                        </tr>`
                    );

                    // Cards mobile
                    $('#publicRankingCards').append(
                        `<div class="ranking-card">
                            <div class="ranking-header">
                                <div class="ranking-position">${medal}</div>
                                <div class="ranking-team">${r.name}</div>
                            </div>
                            <div class="ranking-stats">
                                <div class="stat-item">
                                    <span>Vitórias:</span>
                                    <span>${r.wins || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Derrotas:</span>
                                    <span>${r.losses || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Pontos Pró:</span>
                                    <span>${r.scored || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Pontos Contra:</span>
                                    <span>${r.conceded || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Saldo:</span>
                                    <span>${(r.scored || 0) - (r.conceded || 0)}</span>
                                </div>
                            </div>
                        </div>`
                    );
                });

                // Partidas - ORDENADAS CORRETAMENTE E COM NOMES ALTERADOS
                $('#publicMatches').empty();

                // Filtrar partidas conforme a flag
                let filteredMatches = matches;
                if (!INCLUI_PARTIDAS_OPCIONAIS) {
                    filteredMatches = matches.filter(m => m.matchCode !== 'P9' && m.matchCode !== 'P10');
                }

                // Agrupar partidas por rodada
                const matchesByRound = {};
                filteredMatches.forEach(m => {
                    if (!matchesByRound[m.round]) {
                        matchesByRound[m.round] = [];
                    }
                    matchesByRound[m.round].push(m);
                });

                // Ordenar rodadas
                const rounds = Object.keys(matchesByRound).sort();

                // Para cada rodada, ordenar partidas numericamente
                rounds.forEach(round => {
                    const roundMatches = matchesByRound[round]
                        .sort((a, b) => {
                            const numA = parseInt(a.matchCode.replace('P', ''));
                            const numB = parseInt(b.matchCode.replace('P', ''));
                            return numA - numB;
                        });

                    let roundTitle = "";
                    if (round === "1") roundTitle = "Rodada 1";
                    else if (round === "2") roundTitle = "Rodada 2";
                    else if (round === "3") roundTitle = "Finais";
                    else roundTitle = `Rodada ${round}`;

                    $('#publicMatches').append(`<div class="round-title">${roundTitle}</div>`);

                    roundMatches.forEach(m => {
                        const teamA = getNameById(teams, m.teamA);
                        const teamB = getNameById(teams, m.teamB);
                        const score = m.status === 'finalizado' ? `${m.scoreA} x ${m.scoreB}` : 'A definir';
                        const badgeClass = m.status === 'finalizado' ? 'ok' : 'muted';

                        // Alterar nomes P11 e P12
                        let matchCode = m.matchCode;
                        if (m.matchCode === 'P11') matchCode = 'Semifinal';
                        if (m.matchCode === 'P12') matchCode = 'Final';

                        // MELHORIA: Novo layout responsivo para partidas
                        $('#publicMatches').append(
                            `<div class="match-item ${m.status === 'finalizado' ? 'match-finished' : 'match-pending'}">
                                <div class="match-header">
                                    <span class="match-code">${matchCode}</span>
                                    ${m.status === 'finalizado' ?
                                '<span class="match-status finished">✓ Finalizado</span>' :
                                '<span class="match-status pending">⏳ Pendente</span>'
                            }
                                </div>
                                <div class="match-content">
                                    <div class="team team-a">
                                        <span class="team-name">${teamA || '—'}</span>
                                        ${m.status === 'finalizado' ? `<span class="team-score ${m.scoreA > m.scoreB ? 'winner' : ''}">${m.scoreA}</span>` : ''}
                                    </div>
                                    
                                    <div class="vs-divider">
                                        <span class="vs-text">vs</span>
                                    </div>
                                    
                                    <div class="team team-b">
                                        <span class="team-name">${teamB || '—'}</span>
                                        ${m.status === 'finalizado' ? `<span class="team-score ${m.scoreB > m.scoreA ? 'winner' : ''}">${m.scoreB}</span>` : ''}
                                    </div>
                                </div>
                                ${m.status !== 'finalizado' ?
                                '<div class="match-pending-text">A definir</div>' :
                                '<div class="match-result">Placar final</div>'
                            }
                            </div>`
                        );
                    });
                });

            } catch (error) {
                console.error('Erro ao renderizar dados públicos:', error);
            }
        }

        // --- RENDERIZAÇÃO ADMIN - SEPARADA ---
        async function renderAdminTeams() {
            try {
                const teams = await getTeamsSnap();

                // Lista de times no admin - APENAS NA ABA CRIAR TIMES
                $('#adminTeams').empty();
                teams.forEach(t => {
                    const playersSorted = [...(t.players || [])].sort((a, b) => a.localeCompare(b));
                    $('#adminTeams').append(
                        `<div class="team-card">
                    <div class="flex" style="justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h4>${t.name}</h4>
                            <div class="players-list">
                                ${playersSorted.join(', ')}
                            </div>
                        </div>
                        <button class="delTeam danger small" data-id="${t.id}">Excluir</button>
                    </div>
                </div>`
                    );
                });
            } catch (error) {
                console.error('Erro ao renderizar times admin:', error);
            }
        }

        async function renderAdminMatches() {
            try {
                const teams = await getTeamsSnap();
                const matches = await getMatchesSnap();

                // Partidas no admin - APENAS NA ABA GERENCIAR PARTIDAS
                $('#adminMatches').empty();

                // Filtrar partidas conforme a flag
                let filteredMatches = matches;
                if (!INCLUI_PARTIDAS_OPCIONAIS) {
                    filteredMatches = matches.filter(m => m.matchCode !== 'P9' && m.matchCode !== 'P10');
                }

                // Agrupar partidas por rodada
                const matchesByRound = {};
                filteredMatches.forEach(m => {
                    if (!matchesByRound[m.round]) {
                        matchesByRound[m.round] = [];
                    }
                    matchesByRound[m.round].push(m);
                });

                // Ordenar rodadas
                const rounds = Object.keys(matchesByRound).sort();

                // Para cada rodada, ordenar partidas numericamente
                rounds.forEach(round => {
                    const roundMatches = matchesByRound[round]
                        .sort((a, b) => {
                            const numA = parseInt(a.matchCode.replace('P', ''));
                            const numB = parseInt(b.matchCode.replace('P', ''));
                            return numA - numB;
                        });

                    let roundTitle = "";
                    if (round === "1") roundTitle = "Rodada 1";
                    else if (round === "2") roundTitle = "Rodada 2";
                    else if (round === "3") roundTitle = "Finais";
                    else roundTitle = `Rodada ${round}`;

                    $('#adminMatches').append(`<div class="round-title">${roundTitle}</div>`);

                    roundMatches.forEach(m => {
                        const teamA = getNameById(teams, m.teamA);
                        const teamB = getNameById(teams, m.teamB);
                        const statusBadge = m.status === 'finalizado' ?
                            '<span class="badge ok">Finalizado</span>' :
                            '<span class="badge muted">Pendente</span>';

                        // Alterar nomes P11 e P12
                        let matchCode = m.matchCode;
                        if (m.matchCode === 'P11') matchCode = 'Semifinal';
                        if (m.matchCode === 'P12') matchCode = 'Final';

                        // MELHORIA: Layout melhorado para admin de partidas
                        const html = `
                    <div class="admin-match-card">
                        <div class="admin-match-header">
                            <div>
                                <strong>${matchCode}</strong>
                                ${statusBadge}
                            </div>
                            <div class="admin-match-teams">
                                <strong>${teamA || '—'}</strong> vs <strong>${teamB || '—'}</strong>
                            </div>
                        </div>
                        <div class="admin-match-controls">
                            <input class="score-input scoreA" data-id="${m.id}" 
                                   placeholder="A" value="${m.scoreA || ''}" 
                                   ${!teamA || !teamB ? 'disabled' : ''}>
                            <span>X</span>
                            <input class="score-input scoreB" data-id="${m.id}" 
                                   placeholder="B" value="${m.scoreB || ''}"
                                   ${!teamA || !teamB ? 'disabled' : ''}>
                            <button class="btnSaveScore primary" data-id="${m.id}"
                                    ${!teamA || !teamB ? 'disabled' : ''}>Salvar</button>
                            ${m.status === 'finalizado' ?
                                '<button class="btnResetScore danger small" data-id="' + m.id + '">Resetar</button>' : ''}
                        </div>
                        ${(!teamA || !teamB) ? '<small class="muted">Defina os times primeiro</small>' : ''}
                    </div>
                `;
                        $('#adminMatches').append(html);
                    });
                });
            } catch (error) {
                console.error('Erro ao renderizar partidas admin:', error);
            }
        }

        // --- FUNÇÕES AUXILIARES ---
        function getNameById(teams, id) {
            if (!id) return null;
            const t = teams.find(x => x.id === id);
            return t ? t.name : null;
        }

        function computeRankingFromData(teams, matches) {
            const map = {};
            teams.forEach(t => {
                map[t.id] = {
                    id: t.id,
                    name: t.name,
                    players: t.players || [],
                    wins: 0,
                    losses: 0,
                    scored: 0,
                    conceded: 0
                };
            });

            // Calcular estatísticas dos jogos finalizados
            matches.forEach(m => {
                if (m.status !== 'finalizado') return;
                const a = map[m.teamA];
                const b = map[m.teamB];
                if (!a || !b) return;

                a.scored += Number(m.scoreA || 0);
                a.conceded += Number(m.scoreB || 0);
                b.scored += Number(m.scoreB || 0);
                b.conceded += Number(m.scoreA || 0);

                if (Number(m.scoreA) > Number(m.scoreB)) {
                    a.wins++;
                    b.losses++;
                } else if (Number(m.scoreB) > Number(m.scoreA)) {
                    b.wins++;
                    a.losses++;
                }
            });

            // Ordenar por vitórias, depois saldo de pontos
            const arr = Object.values(map);
            arr.sort((A, B) => {
                if (B.wins !== A.wins) return B.wins - A.wins;
                const diffA = A.scored - A.conceded;
                const diffB = B.scored - B.conceded;
                return diffB - diffA;
            });

            return arr;
        }

        // --- GERENCIAMENTO DE PARTIDAS ---
        async function generateStructure() {
            const teams = await getTeamsSnap();
            if (teams.length !== 8) {
                alert(`É necessário exatamente 8 times cadastrados (atualmente: ${teams.length}).`);
                return;
            }

            await deleteAllMatches();

            // Rodada 1 - Partidas iniciais
            await addMatchToDB({
                id: uid(),
                matchCode: 'P1',
                round: 1,
                teamA: teams[0].id,
                teamB: teams[1].id,
                scoreA: null,
                scoreB: null,
                status: 'pendente',
                winner: null
            });

            await addMatchToDB({
                id: uid(),
                matchCode: 'P2',
                round: 1,
                teamA: teams[2].id,
                teamB: teams[3].id,
                scoreA: null,
                scoreB: null,
                status: 'pendente',
                winner: null
            });

            await addMatchToDB({
                id: uid(),
                matchCode: 'P3',
                round: 1,
                teamA: teams[4].id,
                teamB: teams[5].id,
                scoreA: null,
                scoreB: null,
                status: 'pendente',
                winner: null
            });

            await addMatchToDB({
                id: uid(),
                matchCode: 'P4',
                round: 1,
                teamA: teams[6].id,
                teamB: teams[7].id,
                scoreA: null,
                scoreB: null,
                status: 'pendente',
                winner: null
            });

            // Rodada 2 - Placeholders
            for (let i = 5; i <= 8; i++) {
                await addMatchToDB({
                    id: uid(),
                    matchCode: `P${i}`,
                    round: 2,
                    teamA: null,
                    teamB: null,
                    scoreA: null,
                    scoreB: null,
                    status: 'pendente',
                    winner: null
                });
            }

            // Rodada 3
            if (INCLUI_PARTIDAS_OPCIONAIS) {
                for (let i = 9; i <= 10; i++) {
                    await addMatchToDB({
                        id: uid(),
                        matchCode: `P${i}`,
                        round: 3,
                        teamA: null,
                        teamB: null,
                        scoreA: null,
                        scoreB: null,
                        status: 'pendente',
                        winner: null
                    });
                }
            }

            // Partidas finais
            for (let i = 11; i <= 12; i++) {
                await addMatchToDB({
                    id: uid(),
                    matchCode: `P${i}`,
                    round: 3,
                    teamA: null,
                    teamB: null,
                    scoreA: null,
                    scoreB: null,
                    status: 'pendente',
                    winner: null
                });
            }

            alert('Estrutura de partidas gerada com sucesso!');
        }

        async function prepareR2() {
            const teams = await getTeamsSnap();
            const matches = await getMatchesSnap();

            // Encontrar vencedores e perdedores da rodada 1
            const results = {};
            for (let i = 1; i <= 4; i++) {
                const match = matches.find(m => m.matchCode === `P${i}`);
                if (match && match.status === 'finalizado') {
                    results[`P${i}`] = {
                        winner: match.winner,
                        loser: match.winner === match.teamA ? match.teamB : match.teamA
                    };
                }
            }

            // Atualizar rodada 2 baseado nos resultados
            const updates = [];

            // P5: Vencedor P1 vs Vencedor P2
            if (results.P1 && results.P2) {
                updates.push({
                    matchCode: 'P5',
                    teamA: results.P1.winner,
                    teamB: results.P2.winner
                });
            }

            // P6: Vencedor P3 vs Vencedor P4  
            if (results.P3 && results.P4) {
                updates.push({
                    matchCode: 'P6',
                    teamA: results.P3.winner,
                    teamB: results.P4.winner
                });
            }

            // P7: Perdedor P1 vs Perdedor P2
            if (results.P1 && results.P2) {
                updates.push({
                    matchCode: 'P7',
                    teamA: results.P1.loser,
                    teamB: results.P2.loser
                });
            }

            // P8: Perdedor P3 vs Perdedor P4
            if (results.P3 && results.P4) {
                updates.push({
                    matchCode: 'P8',
                    teamA: results.P3.loser,
                    teamB: results.P4.loser
                });
            }

            // Aplicar atualizações
            for (const update of updates) {
                const match = matches.find(m => m.matchCode === update.matchCode);
                if (match) {
                    await updateMatchInDB(match.id, {
                        teamA: update.teamA,
                        teamB: update.teamB,
                        status: 'pendente',
                        scoreA: null,
                        scoreB: null,
                        winner: null
                    });
                }
            }

            alert('Rodada 2 atualizada com base nos resultados da Rodada 1');
        }

        async function prepareR3() {
            const teams = await getTeamsSnap();
            const matches = await getMatchesSnap();
            const ranked = computeRankingFromData(teams, matches);

            if (ranked.length < 8) {
                alert('É necessário ter 8 times para montar a rodada 3');
                return;
            }

            // Mapear posições do ranking para as partidas
            const assignments = {
                'P11': { teamA: ranked[2].id, teamB: ranked[3].id }, // 3º vs 4º
                'P12': { teamA: ranked[0].id, teamB: ranked[1].id }  // 1º vs 2º
            };

            if (INCLUI_PARTIDAS_OPCIONAIS) {
                assignments['P9'] = { teamA: ranked[6].id, teamB: ranked[7].id }; // 7º vs 8º
                assignments['P10'] = { teamA: ranked[4].id, teamB: ranked[5].id }; // 5º vs 6º
            }

            // Aplicar atribuições
            for (const [matchCode, teams] of Object.entries(assignments)) {
                const match = matches.find(m => m.matchCode === matchCode);
                if (match) {
                    await updateMatchInDB(match.id, {
                        teamA: teams.teamA,
                        teamB: teams.teamB,
                        status: 'pendente',
                        scoreA: null,
                        scoreB: null,
                        winner: null
                    });
                }
            }

            alert('Rodada 3 montada conforme ranking atual');
        }

        // --- GERENCIAMENTO DE PLACARES ---
        async function saveScore(matchId, scoreA, scoreB) {
            if (scoreA === '' || scoreB === '') {
                alert('Preencha ambos os placares');
                return;
            }

            const a = Number(scoreA);
            const b = Number(scoreB);

            if (isNaN(a) || isNaN(b)) {
                alert('Placares devem ser números válidos');
                return;
            }

            const match = (await getMatchesSnap()).find(m => m.id === matchId);
            if (!match) {
                alert('Partida não encontrada');
                return;
            }

            const winner = a > b ? match.teamA : b > a ? match.teamB : null;

            await updateMatchInDB(matchId, {
                scoreA: a,
                scoreB: b,
                status: 'finalizado',
                winner: winner
            });

            alert('Placar salvo com sucesso!');
        }

        async function resetScore(matchId) {
            await updateMatchInDB(matchId, {
                scoreA: null,
                scoreB: null,
                status: 'pendente',
                winner: null
            });
            alert('Placar resetado!');
        }

        // --- CRUD DE TIMES ---
        async function deleteTeam(id) {
            if (!confirm('Tem certeza que deseja excluir este time?')) return;
            await db.collection('teams').doc(id).delete();
        }

        async function deleteAllData() {
            if (!confirm('ATENÇÃO: Isso apagará TODOS os times e partidas. Continuar?')) return;
            await deleteAllMatches();
            await deleteAllTeams();
            alert('Todos os dados foram apagados.');
        }

        // --- QR CODE ---
        function genQRCode() {
            const url = window.location.href;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            $('#qrcode').html(`
                <img src="${qrUrl}" alt="QR Code para o torneio">
                <div class="small" style="margin-top:8px;">
                    <a href="${url}" target="_blank">${url}</a>
                </div>
            `);
        }

        // --- SISTEMA DE NAVEGAÇÃO ---
        function setupNavigation() {
            // Recuperar aba salva ou usar 'public' como padrão
            const savedTab = localStorage.getItem('currentTab') || 'public';
            $('#navSelect').val(savedTab);
            $('.tab-content').removeClass('active');
            $(`#${savedTab}-tab`).addClass('active');

            $('#navSelect').on('change', function () {
                const tabId = $(this).val();

                // Salvar aba no localStorage
                localStorage.setItem('currentTab', tabId);

                // Remover classe active de todos os conteúdos
                $('.tab-content').removeClass('active');

                // Adicionar classe active ao conteúdo correspondente
                $(`#${tabId}-tab`).addClass('active');

                // Atualizar seções internas admin
                if (isAdmin()) updateAdminSections();
            });
        }

        function updateAdminSections() {
            const adminLoggedIn = isAdmin();

            if (adminLoggedIn) {
                $('#admin-section').show();
                $('#login-section').hide();
                $('.admin-only').show();
                $('.admin-only').prop('disabled', false);

                // Esconder seções internas das abas admin (será mostrado só na aba ativa)
                $('#teams-admin-section').hide();
                $('#matches-admin-section').hide();

                // Mostrar a seção correspondente à aba atual
                const currentTab = $('#navSelect').val();
                if (currentTab === 'create-teams') $('#teams-admin-section').show();
                if (currentTab === 'manage-matches') $('#matches-admin-section').show();

                // Renderizar dados apenas na aba correspondente
                if (currentTab === 'create-teams') renderAdminTeams();
                if (currentTab === 'manage-matches') renderAdminMatches();
            } else {
                $('#admin-section').hide();
                $('#login-section').show();
                $('.admin-only').hide();
                $('.admin-only').prop('disabled', true);

                // Se estiver em uma aba admin, voltar para pública
                if ($('#navSelect').val() === 'create-teams' || $('#navSelect').val() === 'manage-matches') {
                    $('#navSelect').val('public').trigger('change');
                }
            }
        }

        function updateToggle() {
            $('#toggleOptional').prop('checked', INCLUI_PARTIDAS_OPCIONAIS);
            $('#flagLabel').text(INCLUI_PARTIDAS_OPCIONAIS ? 'SIM' : 'NÃO');
        }

        // --- INICIALIZAÇÃO ---
        $(function () {
            // Configuração inicial
            updateToggle();

            // Setup
            setupNavigation();
            setupRealtime();
            genQRCode();

            // Verificar login e atualizar interface
            updateAdminSections();
            renderPublic();
            if (isAdmin()) {
                renderAdminTeams();
                renderAdminMatches();
            }

            // Event Listeners
            $('#btnLogin').on('click', function () {
                const user = $('#loginUser').val();
                const pass = $('#loginPass').val();

                if (user === ADMIN_USER && pass === ADMIN_PASS) {
                    localStorage.setItem('isAdmin', 'true');
                    updateAdminSections();
                    renderAdminTeams();
                    renderAdminMatches();
                    alert('Login realizado com sucesso!');
                } else {
                    alert('Credenciais inválidas!');
                }
            });

            $('#btnLogout').on('click', function () {
                localStorage.removeItem('isAdmin');
                updateAdminSections();
                alert('Logout realizado!');
            });

            // No evento do toggleOptional
            $('#toggleOptional').on('change', function () {
                INCLUI_PARTIDAS_OPCIONAIS = $(this).is(':checked');
                updateToggle();
                renderPublic();
                if (isAdmin()) {
                    renderAdminMatches();
                }
            });

            $('#btnAddTeam').on('click', async function () {
                const name = $('#teamName').val().trim();
                if (!name) {
                    alert('Nome do time é obrigatório');
                    return;
                }

                const players = $('#teamPlayers').val()
                    .split(',')
                    .map(p => p.trim())
                    .filter(p => p !== '');

                const team = {
                    id: uid(),
                    name: name,
                    players: players,
                    wins: 0,
                    scored: 0,
                    conceded: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await addTeamToDB(team);
                    $('#teamName').val('');
                    $('#teamPlayers').val('');
                    alert('Time adicionado com sucesso!');
                } catch (error) {
                    alert('Erro ao adicionar time: ' + error.message);
                }
            });

            $('#btnClearTeams').on('click', async function () {
                if (!confirm('Tem certeza que deseja apagar TODOS os times?')) return;
                try {
                    await deleteAllTeams();
                    alert('Todos os times foram removidos!');
                } catch (error) {
                    alert('Erro ao limpar times: ' + error.message);
                }
            });

            $(document).on('click', '.delTeam', async function () {
                const teamId = $(this).data('id');
                await deleteTeam(teamId);
            });

            // --- FUNÇÕES COM CONFIRMAÇÃO ---
            async function generateStructureWithConfirmation() {
                const matches = await getMatchesSnap();

                if (matches.length > 0) {
                    const confirmar = confirm(
                        "ATENÇÃO: Gerar a Rodada 1 irá APAGAR TODAS as partidas existentes!\n\n" +
                        "Isso inclui partidas da Rodada 2, Rodada 3 e quaisquer placares já preenchidos.\n\n" +
                        "Deseja continuar?"
                    );
                    if (!confirmar) return;
                }

                await generateStructure();
            }

            async function prepareR2WithConfirmation() {
                const matches = await getMatchesSnap();
                const r2Matches = matches.filter(m => m.round === "2");
                const r2WithData = r2Matches.filter(m => m.teamA || m.teamB || m.scoreA !== null || m.scoreB !== null);

                if (r2WithData.length > 0) {
                    const confirmar = confirm(
                        "ATENÇÃO: Montar a Rodada 2 irá SOBRESCREVER os times e resetar os placares das partidas da Rodada 2!\n\n" +
                        "Isso afetará " + r2WithData.length + " partida(s) que já possuem dados.\n\n" +
                        "Deseja continuar?"
                    );
                    if (!confirmar) return;
                }

                await prepareR2();
            }

            async function prepareR3WithConfirmation() {
                const matches = await getMatchesSnap();
                const r3Matches = matches.filter(m => m.round === "3");
                const r3WithData = r3Matches.filter(m => m.teamA || m.teamB || m.scoreA !== null || m.scoreB !== null);

                if (r3WithData.length > 0) {
                    const confirmar = confirm(
                        "ATENÇÃO: Montar a Rodada 3 irá SOBRESCREVER os times e resetar os placares das partidas da Rodada 3!\n\n" +
                        "Isso afetará " + r3WithData.length + " partida(s) que já possuem dados.\n\n" +
                        "Deseja continuar?"
                    );
                    if (!confirmar) return;
                }

                await prepareR3();
            }

            $('#btnGenerate, #btnGenerate2').on('click', async function () {
                await generateStructureWithConfirmation();
                renderPublic();
                if (isAdmin()) {
                    renderAdminMatches();
                }
            });

            $('#btnPrepareR2, #btnPrepareR2-2').on('click', async function () {
                await prepareR2WithConfirmation();
                renderPublic();
                if (isAdmin()) {
                    renderAdminMatches();
                }
            });

            $('#btnPrepareR3, #btnPrepareR3-2').on('click', async function () {
                await prepareR3WithConfirmation();
                renderPublic();
                if (isAdmin()) {
                    renderAdminMatches();
                }
            });

            $('#btnDeleteAll').on('click', async function () {
                await deleteAllData();
                renderPublic();
                if (isAdmin()) {
                    renderAdminTeams();
                    renderAdminMatches();
                }
            });

            $('#btnRefresh').on('click', function () {
                renderPublic();
                if (isAdmin()) {
                    renderAdminTeams();
                    renderAdminMatches();
                }
            });

            $(document).on('click', '.btnSaveScore', async function () {
                const matchId = $(this).data('id');
                const scoreA = $(`.scoreA[data-id="${matchId}"]`).val();
                const scoreB = $(`.scoreB[data-id="${matchId}"]`).val();
                await saveScore(matchId, scoreA, scoreB);
            });

            $(document).on('click', '.btnResetScore', async function () {
                const matchId = $(this).data('id');
                await resetScore(matchId);
            });
        });
    </script>
</body>

</html>